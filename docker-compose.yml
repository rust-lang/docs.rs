x-healthcheck: &healthcheck-interval
    interval: 10s
    timeout: 1s
    start_interval: 1s
    start_period: 10s

x-environment: &environment
    RUST_BACKTRACE: true

    DOCSRS_PREFIX: /opt/docsrs/prefix
    DOCSRS_COMPILER_METRICS_PATH: /opt/docsrs/prefix/metrics

    DOCSRS_DATABASE_URL: postgresql://cratesfyi:password@db
    DOCSRS_MIN_POOL_IDLE: 1
    DOCSRS_MIN_POOL_SIZE: 2
    DOCSRS_MAX_POOL_SIZE: 10
    DOCSRS_MAX_LEGACY_POOL_SIZE: 10

    DOCSRS_STORAGE_BACKEND: s3

    S3_ENDPOINT: http://s3:9000
    AWS_ACCESS_KEY_ID: cratesfyi
    AWS_SECRET_ACCESS_KEY: secret_key

    DOCSRS_RENDER_THREADS: 2

    DOCSRS_RUSTWIDE_WORKSPACE: /opt/docsrs/rustwide
    DOCSRS_DOCKER: true
    DOCSRS_DOCKER_IMAGE: ghcr.io/rust-lang/crates-build-env/linux-micro
    DOCSRS_BUILD_CPU_LIMIT: 2
    DOCSRS_INCLUDE_DEFAULT_TARGETS: false

x-build: &build
    context: .
    dockerfile: ./dockerfiles/Dockerfile
    args:
        PROFILE: dev
        PROFILE_DIR: debug

x-builder: &builder
    build:
        <<: *build
        target: build-server
    platform: "linux/amd64"
    depends_on:
        - db
        - s3
    environment: *environment
    env_file:
        - .docker.env
    healthcheck:
        <<: *healthcheck-interval
        test: curl --silent --fail localhost:3000/about/metrics

services:
    web:
        build:
            <<: *build
            target: web-server
        platform: "linux/amd64"
        depends_on:
            - db
            - s3
        ports:
            - "3000:80"
        environment: *environment
        env_file:
            - .docker.env
        healthcheck:
            <<: *healthcheck-interval
            test: curl --silent --fail localhost:80/about/metrics

    # Include the registry watcher with
    # `docker compose --profile watch up --build --wait`
    registry-watcher:
        build:
            <<: *build
            target: registry-watcher
        platform: "linux/amd64"
        depends_on:
            - db
        volumes:
            - "cratesio-index:/opt/docsrs/prefix/crates.io-index"
            - "./static:/opt/docsrs/static:ro"
        environment: *environment
        env_file:
            - .docker.env
        profiles:
            - watch
            - all
        healthcheck:
            <<: *healthcheck-interval
            test: curl --silent --fail localhost:3000/about/metrics

    builder-a:
        <<: *builder
        volumes:
            - ".rustwide-docker/builder-a:/opt/docsrs/rustwide"
            - "./ignored/cratesfyi-prefix/metrics:/opt/docsrs/prefix/metrics"
            - "/var/run/docker.sock:/var/run/docker.sock"

    builder-b:
        <<: *builder
        volumes:
            - ".rustwide-docker/builder-b:/opt/docsrs/rustwide"
            - "./ignored/cratesfyi-prefix/metrics:/opt/docsrs/prefix/metrics"
            - "/var/run/docker.sock:/var/run/docker.sock"

    cli:
        build:
            <<: *build
            target: cli
        platform: "linux/amd64"
        depends_on:
            - db
            - s3
        volumes:
            - "cratesio-index:/opt/docsrs/prefix/crates.io-index"
        environment: *environment
        env_file:
            - .docker.env
        profiles:
            - all

    db:
        build:
            context: ./dockerfiles
            dockerfile: ./Dockerfile-postgres
        volumes:
            - postgres-data:/var/lib/postgresql/data
        environment:
            POSTGRES_USER: cratesfyi
            POSTGRES_PASSWORD: password
        ports:
            # Use a non-standard port on the host to avoid conflicting with existing postgres servers
            - "127.0.0.1:15432:5432"
        healthcheck:
            <<: *healthcheck-interval
            test: pg_isready --username cratesfyi

    s3:
        image: minio/minio
        entrypoint: >
            /bin/sh -c "
                mkdir -p /data/rust-docs-rs;
                minio server /data --console-address ":9001";
            "
        ports:
            - "127.0.0.1:9000:9000"
            - "127.0.0.1:9001:9001"
        volumes:
            - minio-data:/data
        environment:
            MINIO_ROOT_USER: cratesfyi
            MINIO_ROOT_PASSWORD: secret_key
        healthcheck:
            <<: *healthcheck-interval
            test: mc ready local

    prometheus:
        build:
            context: ./dockerfiles
            dockerfile: ./Dockerfile-prometheus
        ports:
            - "127.0.0.1:9090:9090"
        healthcheck:
            <<: *healthcheck-interval
            test: promtool check healthy

    gui_tests:
        build:
            context: .
            dockerfile: ./dockerfiles/Dockerfile-gui-tests
        network_mode: "host"
        extra_hosts:
            - "host.docker.internal:host-gateway"
        volumes:
            - "${PWD}:/build/out"
        profiles:
            - all

volumes:
    postgres-data: {}
    minio-data: {}
    cratesio-index: {}
